#!/bin/bash

#Getting cur user
cur_user=$SUDO_USER

##################################################################################
##################################################################################
# Perform system general maintainence
##################################################################################
##################################################################################
echo "1. Performing system updates and general maintainence"
#Update package list and distro
apt -y update
apt -y dist-upgrade
apt -y autoremove

echo "2. Installing needed dependencies"
#Install package dependencies
apt -y install docker\
	autossh\
	moreutils\
	network-manager\
	net-tools

echo "3. Pulling needed docker image openvas-docker-lite"
#Pull OpenVAS standalone docker image (Credit to immauss)
docker pull immauss/openvas

##################################################################################
##################################################################################
# Create needed directories for volume mounting to docker
##################################################################################
##################################################################################

echo "4. Creating temp_stage folder"
#temp dir for staging
mkdir /home/$cur_user/siteone-scanner &&\
	mkdir /home/$cur_user/files-to-copy



#############################i#####################################################
##################################################################################
# Preemptively get pub key from remote server
##################################################################################
##################################################################################

echo "5. Getting DMZ server public key for SSH reverse tunnel... UPDATE IP IN SCRIPT IF NEEDED"
#get host pub key from remote SSH server
ssh-keyscan -H -p 45566 192.69.100.14 >> /home/$cur_user/.ssh/known_hosts

##################################################################################
##################################################################################
#Generate RSA key and copy it to .ssh for user
##################################################################################
##################################################################################

echo "6. Generating public and private client key for the current user to run script"
/bin/su -c "ssh-keygen -f id_rsa -t rsa -N ''" - $cur_user

echo "7. Copying keys to users ~/.ssh directory"
cp /home/$cur_user/id_rsa.pub /home/$cur_user/.ssh/ &&\
	cp /home/$cur_user/id_rsa.pub /home/$cur_user/files-to-copy/ &&\
       	cp /home/$cur_user/id_rsa /home/$cur_user/.ssh/

##################################################################################
##################################################################################
# download script to run containers and set up autostart
##################################################################################
##################################################################################
echo "13. Downloading scripts to run scans to /home/scanuser/gvm-data"
wget -O run_scan_containers.sh https://raw.githubusercontent.com/tjobarow/Vuln_Scanner_Files/main/run_scan_containers.sh
wget -O docker_kill.sh https://raw.githubusercontent.com/tjobarow/Vuln_Scanner_Files/main/docker_kill.sh
chmod +x run_scan_containers.sh
chmod +x docker_kill.sh

##################################################################################
##################################################################################
# Download docker scan service and copy it to systemd
##################################################################################
##################################################################################
#copy new service to systemd
echo "14. Downloading docker_scan.service that will run scans on startup"
cd /home/$cur_user/temp_stage
wget -O docker_scan.service https://raw.githubusercontent.com/tjobarow/Vuln_Scanner_Files/main/docker_scan.service

echo "15. Copying docker_scan.service to systemd"
cp docker_scan.service /etc/systemd/system/

##################################################################################
##################################################################################
# RELOAD DAEMON AND REGISTER NEW SERVICES
##################################################################################
##################################################################################
#reload the daemon and start service, enable it for autostart
echo "16. Reloading system daemon"
systemctl daemon-reload

echo "20. Setup is complete!"
